% FIX Marginnote duplication
\usepackage{savesym}
\savesymbol{marginfigure}
\savesymbol{marginnote}
\savesymbol{sidenote}

\usepackage{needspace}
\usepackage[]{titlesec}
\usepackage[]{ccicons}
\usepackage{fontawesome5}

% = Colors =
\usepackage{xcolor}
\definecolor{OffBlack}{HTML}{191919}
\definecolor{OffWhite}{HTML}{fffff8}
\definecolor{DullRed}{HTML}{8C2E24}
\definecolor{TarHeelBlue}{HTML}{4b9cd3}
\definecolor{HopkinsBlue}{HTML}{68ace5}

% = Fonts =
\usepackage{fontspec}
\setmainfont{Literata}[Mapping=tex-text]
\setsansfont{Adelle Sans}[Mapping=tex-text]
\setmonofont[Scale=0.90]{LFT Etica Mono}
\setsidenotefont{\rmfamily\scriptsize}
\setcaptionfont{\sffamily\scriptsize}
\setmarginnotefont{\sffamily\scriptsize}

% = Lists =
\usepackage{enumitem}
\setlistdepth{20}
\setlist[itemize]{label={}}

% = Headings =
% \titlespacing*{<command>}{<left>}{<before-sep>}{<after-sep>}
\titlespacing*{\section}{0em}{4\baselineskip}{1\baselineskip}
\titlespacing*{\subsection}{0em}{2\baselineskip}{1\baselineskip}
\titlespacing*{\subsubsection}{0em}{2\baselineskip}{1\baselineskip}
\titlespacing*{\paragraph}{0em}{2\baselineskip}{.5\baselineskip}
\titlespacing*{\subparagraph}{0em}{1\baselineskip}{.5\baselineskip}

% Numbering
\setcounter{secnumdepth}{2}
\renewcommand\thesection{\arabic{section}}

% Chapter title
\titleformat{\section}%
  [block]
  {\newpage\begin{fullwidth}\raggedright\sffamily\Large\color{DullRed}}
  {\thesection ~~}
  {0em}
  {}
  [\end{fullwidth}]

  % Section title
\titleformat{\subsection}
  [block]
  {\needspace{8\baselineskip}\raggedright\sffamily\Huge\color{DullRed}}
  {\thesubsection ~~}
  {0em}
  {}
  []

% Case, etc. title
\titleclass{\subsubsection}{straight}
\titleformat{\subsubsection}
  [block]
  {\needspace{6\baselineskip}\raggedright\rmfamily\LARGE\color{DullRed}}
  {\theparagraph ~~}
  {0em}
  {}
  [\vspace{-1em}\textcolor{DullRed}{\rule{\textwidth}{1pt}}]

% Case, etc. first heading: Large, bold 
\titleclass{\paragraph}{straight}
\titleformat{\paragraph}
  [block]
  {\needspace{3\baselineskip}\raggedright\rmfamily\Large}
  {\theparagraph ~~}
  {0em}
  {}
  []

% Case, etc. second heading: large, italic
\titleclass{\subparagraph}{straight}
\titleformat{\subparagraph}
  [block]
  {\needspace{3\baselineskip}\raggedright\itshape\large}
  {\thesubparagraph}
  {0em}
  {}
  []

% ============
% = Epigraph =
% ============

\usepackage{epigraph}
% \setlength\epigraphwidth{.5\textwidth}
\setlength\epigraphrule{0pt}
\renewcommand{\epigraphsize}{\small}

% Full Page Epigraph in Frontmatter
\newcommand{\openepigraph}[3]{ % This block sets up a command for printing an epigraph with 2 arguments - the quote and the author
{\noindent\rmfamily\normalsize
\faIcon{quote-left} {\itshape{#1}}
\begin{flushright}\noindent\faIcon{pen-fancy} ~{#2}, {\itshape{#3}} \end{flushright}}
}

% = Link style =

\usepackage{hyperref}
\usepackage{bookmark}
\hypersetup{
  colorlinks=true,
  linkcolor=DullRed,
  citecolor=DullRed,
  urlcolor=DullRed,
  pdftitle={$title$},
  pdfauthor={$author$},
  pdfcreator={LaTeX via pandoc}}
\urlstyle{texttt}

%%%%%%%
%  FIX Makeuppercase error
%  FIX Font clash Math error
%  See https://tex.stackexchange.com/q/202142/157312
% 

\renewcommand{\textls}[2][5]{%
  \begingroup\addfontfeatures{LetterSpace=#1}#2\endgroup
}
\renewcommand{\allcapsspacing}[1]{\textls[15]{#1}}
\renewcommand{\smallcapsspacing}[1]{\textls[10]{#1}}
\renewcommand{\allcaps}[1]{\textls[15]{\MakeTextUppercase{#1}}}
\renewcommand{\smallcaps}[1]{\smallcapsspacing{\scshape\MakeTextLowercase{#1}}}
\renewcommand{\textsc}[1]{\smallcapsspacing{\textsmallcaps{#1}}}

\PassOptionsToPackage{no-math}{fontspec}
% \usepackage[mathlf, minionint,footnotefigures, frenchmath]{MinionPro}
% \setmainfont{$$}
% \setsansfont{TeX Gyre Heros}[Scale=MatchUppercase]

\ExplSyntaxOn
\int_new:N \l_mathcode_minus_int
\int_new:N \l_mathcode_equal_int
\exp_args:Nx \AtBeginDocument {
  \exp_not:n {
    \int_set:Nn \l_mathcode_minus_int { \XeTeXmathcodenum `\- }
    \int_set:Nn \l_mathcode_equal_int { \XeTeXmathcodenum `\= }
  }
  \mathcode \int_eval:n { `\- } = \number \mathcode `\- \scan_stop:
  \mathcode \int_eval:n { `\= } = \number \mathcode `\= \scan_stop:
}
\AtBeginDocument {
  \XeTeXmathcodenum `\- = \l_mathcode_minus_int
  \XeTeXmathcodenum `\= = \l_mathcode_equal_int
}
\ExplSyntaxOff

\usepackage[italic]{mathastext}
% \setromanfont{TeX Gyre Termes}

%%%%%%%

\usepackage{pdfpages}  % for cover page
\graphicspath{{Images/}} % Make Images/ default figure path

\setlength{\parindent}{0pt}%
\setlength{\RaggedRightParindent}{0pt}
\setlength{\JustifyingParindent}{0pt}%
\setlength{\parskip}{\baselineskip}

% =========
% = Title =
% =========

\usepackage{etoolbox}
\makeatletter
\newcommand{\plainsubtitle}{}%     plain-text-only subtitle
\newcommand{\subtitle}[1]{%
  \gdef\@subtitle{#1}%
  \renewcommand{\plainsubtitle}{#1}% use provided plain-text title
  \ifthenelse{\isundefined{\hypersetup}}%
    {}% hyperref is not loaded; do nothing
    {\hypersetup{pdftitle={\plaintitle: \plainsubtitle{}}}}% set the PDF metadata title
}
\renewcommand{\maketitlepage}[0]{%
  \cleardoublepage%
  {%
  \sffamily%
  \raggedright%
  \begin{fullwidth}%
  \fontsize{18}{20}\selectfont\par\noindent\textcolor{DullRed}{\allcaps{\thanklessauthor}}%
  \vspace{11.5pc}%
  \fontsize{36}{40}\selectfont\par\noindent\textcolor{DullRed}{\allcaps{\thanklesstitle}}\par%
  \vspace{5pc}%
  \fontsize{20}{24}\selectfont\par\noindent\textcolor{DullRed}{\allcaps{\plainsubtitle}}%
  \vfill%
  $if(affiliation)$
  \fontsize{14}{16}\selectfont\par\noindent\textcolor{DullRed}{\allcaps{\thanklesspublisher}}%
  $endif$
  \fontsize{14}{16}\selectfont\par\noindent\textcolor{DullRed}{\allcaps{$date$}}%
  \end{fullwidth}%
  }
  \thispagestyle{empty}%
  \clearpage%
}
\makeatother
\title{$title$}
\subtitle{$subtitle$}
\author{$author$}
\publisher{$affiliation$}
\date{$date$}

% ===================
% = Pandoc citeproc =
% ===================

% Pandoc citation processing
% definitions for citeproc citations
\NewDocumentCommand\citeproctext{}{}
\NewDocumentCommand\citeproc{mm}{%
\begingroup\def\citeproctext{#2}\cite{#1}\endgroup}
\makeatletter
% allow citations to break across lines
\let\@cite@ofmt\@firstofone
% avoid brackets around text for \cite:
\def\@biblabel#1{}
\def\@cite#1#2{{#1\if@tempswa , #2\fi}}
\makeatother
\newlength{\cslhangindent}
\setlength{\cslhangindent}{1.5em}
\newlength{\csllabelwidth}
\setlength{\csllabelwidth}{3em}
\newenvironment{CSLReferences}[2] % #1 hanging-indent, #2 entry-spacing
{\begin{list}{}{%
	\setlength{\itemindent}{0pt}
	\setlength{\leftmargin}{0pt}
	\setlength{\parsep}{0pt}
	% turn on hanging indent if param 1 is 1
	\ifodd #1
	\setlength{\leftmargin}{\cslhangindent}
	\setlength{\itemindent}{-1\cslhangindent}
	\fi
	% set entry spacing
	\setlength{\itemsep}{#2\baselineskip}}}
{\end{list}}
\usepackage{calc}
\newcommand{\CSLBlock}[1]{\hfill\break\parbox[t]{\linewidth}{\strut\ignorespaces#1\strut}}
\newcommand{\CSLLeftMargin}[1]{\parbox[t]{\csllabelwidth}{\strut#1\strut}}
\newcommand{\CSLRightInline}[1]{\parbox[t]{\linewidth - \csllabelwidth}{\strut#1\strut}}
\newcommand{\CSLIndent}[1]{\hspace{\cslhangindent}#1}
